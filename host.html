<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Host VIP</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:wght@400;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: #1a5a3a;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(0,0,0,.08) 3px, rgba(0,0,0,.08) 6px),
                repeating-linear-gradient(-45deg, transparent, transparent 3px, rgba(0,0,0,.08) 3px, rgba(0,0,0,.08) 6px),
                radial-gradient(circle at center, #2d6a4f 0%, #1b4332 60%, #081c15 100%);
            color: white;
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Felt texture overlay */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000000' fill-opacity='0.12'%3E%3Cpath d='M50 50c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10zM10 10c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10S0 25.523 0 20s4.477-10 10-10zm10 8c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm40 40c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z' /%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.25;
            pointer-events: none;
        }

        /* Wood rail border */
        .wood-rail {
            position: absolute;
            inset: 0;
            border: 30px solid transparent;
            border-image: linear-gradient(135deg, #4a2511 0%, #2d1507 50%, #654321 100%) 30;
            pointer-events: none;
            z-index: 1;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.6);
        }

        /* HEADER */
        .admin-bar {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            padding: 0 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            pointer-events: none;
        }

        .room-info {
            pointer-events: auto;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(15px);
            padding: 12px 25px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 18px;
            color: #ffd700;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 3px;
        }

        .controls {
            pointer-events: auto;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn-action {
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            border: none;
            font-size: 14px;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3),
                        inset 0 -2px 5px rgba(0,0,0,0.3);
        }

        .btn-action:active { transform: translateY(2px); }
        .btn-reset { background: linear-gradient(145deg, #e74c3c, #c0392b); color: white; }
        .btn-next { background: linear-gradient(145deg, #f39c12, #d35400); color: white; }
        .btn-split { background: linear-gradient(145deg, #3498db, #2980b9); color: white; }
        
        .btn-distribute {
            background: linear-gradient(145deg, #ffd700, #f39c12);
            color: #000;
            display: none;
            animation: distributeGlow 1.5s infinite;
        }

        @keyframes distributeGlow {
            0%, 100% { box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); }
            50% { box-shadow: 0 4px 30px rgba(255, 215, 0, 0.8); }
        }

        /* NOTIFICATIONS */
        .notification-area {
            position: absolute;
            top: 100px;
            right: 40px;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .notification {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            padding: 15px 25px;
            border-radius: 12px;
            border: 2px solid rgba(46, 204, 113, 0.5);
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            animation: slideIn 0.3s, fadeOut 0.5s 2.5s forwards;
            min-width: 250px;
        }

        .notification.all-in { border-color: rgba(231, 76, 60, 0.8); box-shadow: 0 0 30px rgba(231, 76, 60, 0.6); }
        .notification-name { font-size: 16px; font-weight: bold; color: #ffd700; font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; margin-bottom: 5px; }
        .notification-bet { font-size: 24px; color: #2ecc71; font-weight: bold; font-family: 'Bebas Neue', sans-serif; }
        .notification.all-in .notification-bet { color: #e74c3c; }

        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(400px); } }

        /* POT AREA */
        .pot-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 450px;
            height: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }

        .pot-glow {
            position: absolute;
            inset: -50px;
            background: radial-gradient(circle, rgba(255,215,0,0.2) 0%, transparent 70%);
            border-radius: 50%;
            animation: potPulse 3s infinite;
            opacity: 0;
        }

        .pot-glow.active { opacity: 1; }

        @keyframes potPulse { 0%, 100% { transform: scale(0.9); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.6; } }

        .pot-text {
            position: absolute;
            z-index: 20;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(15px);
            padding: 20px 50px;
            border-radius: 30px;
            border: 3px solid rgba(255, 215, 0, 0.4);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6);
        }

        .pot-label { font-size: 14px; color: #888; letter-spacing: 3px; font-weight: bold; margin-bottom: 5px; }
        .pot-val { font-size: 72px; color: #ffd700; font-weight: bold; font-family: 'Bebas Neue', sans-serif; text-shadow: 0 0 40px rgba(255, 215, 0, 0.8), 0 4px 8px rgba(0,0,0,0.8); letter-spacing: 5px; }

        /* CHIPS VISUAL */
        #chip-pile { position: relative; width: 100%; height: 100%; z-index: 5; }
        .chip-visual {
            position: absolute; width: 65px; height: 65px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 18px; box-shadow: 0 6px 20px rgba(0,0,0,0.6);
            transition: all 0.3s; font-family: 'Bebas Neue', sans-serif;
        }
        .chip-visual::before {
            content: ''; position: absolute; inset: -3px; border-radius: 50%; padding: 3px;
            background: repeating-conic-gradient(from 0deg, currentColor 0deg 18deg, transparent 18deg 36deg);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
        }
        .vc100 { background: radial-gradient(circle at 30% 30%, #34495e, #2c3e50 60%, #1a252f); color: #ffd700; }
        .vc25 { background: radial-gradient(circle at 30% 30%, #2ecc71, #27ae60 60%, #229954); color: white; }
        .vc5 { background: radial-gradient(circle at 30% 30%, #e74c3c, #c0392b 60%, #a93226); color: white; }
        .vc1 { background: radial-gradient(circle at 30% 30%, #ffffff, #e8e8e8 60%, #c0c0c0); color: #333; }

        /* PLAYER GRID */
        .player-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 100px 80px; display: flex; flex-wrap: wrap;
            justify-content: space-around; align-content: space-between;
            z-index: 50; pointer-events: none;
        }

        .p-card {
            pointer-events: auto;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            width: 200px; height: 160px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255,255,255,0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 3px solid #dee2e6; transition: all 0.3s; cursor: pointer; position: relative;
        }

        /* NEW: ACTIVE TURN GLOW */
        .p-card.active-turn {
            border-color: #2ecc71;
            box-shadow: 0 0 50px rgba(46, 204, 113, 0.6), 0 15px 40px rgba(0, 0, 0, 0.6);
            transform: scale(1.1);
            z-index: 60;
        }

        /* NEW: SEAT ARROWS */
        .seat-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: rgba(0,0,0,0.6);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-weight: bold;
            opacity: 0; /* Hidden unless hovered */
            transition: all 0.2s;
            z-index: 100;
        }
        
        .p-card:hover .seat-arrow { opacity: 1; }
        .seat-arrow:hover { background: #ffd700; color: black; transform: translateY(-50%) scale(1.2); }
        .arrow-left { left: -15px; }
        .arrow-right { right: -15px; }

        /* DEALER BUTTON */
        .dealer-btn {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 35px;
            height: 35px;
            background: white;
            border: 2px solid black;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: black;
            box-shadow: 0 3px 10px rgba(0,0,0,0.5);
            font-family: serif;
            z-index: 70;
        }

        .p-card.folded {
            opacity: 0.4; filter: grayscale(100%);
            border-color: #555; background: #333; color: #888;
        }
        .p-card.folded.active-turn { transform: none; box-shadow: none; border-color: #555; } /* Folded players don't glow */

        .p-card.selected {
            border-color: #3498db;
            box-shadow: 0 0 30px rgba(52, 152, 219, 0.8);
        }

        .p-avatar {
            width: 45px; height: 45px;
            background: linear-gradient(145deg, #ffd700, #f39c12);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; margin-bottom: 8px;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.5);
        }

        .p-name { font-size: 20px; font-weight: 900; color: #1a202c; margin-bottom: 5px; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px; }
        .folded .p-name { color: #aaa; }

        .p-chips { font-size: 28px; color: #2ecc71; font-weight: bold; margin-bottom: 3px; font-family: 'Bebas Neue', sans-serif; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }

        .p-bet { font-size: 11px; color: #666; font-weight: bold; letter-spacing: 1px; }
        .folded .p-bet { color: #555; }

        .btn-win {
            background: linear-gradient(145deg, #ffd700, #f39c12);
            color: #000; border: none; padding: 6px 18px;
            border-radius: 20px; font-weight: bold; cursor: pointer;
            margin-top: 8px; font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px; box-shadow: 0 3px 15px rgba(255, 215, 0, 0.4);
            transition: all 0.2s;
        }
        .btn-win:active { transform: scale(0.95); }

        /* THE NEW KICK BUTTON */
        .btn-kick {
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 25px;
            height: 25px;
            background: #e74c3c;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 80;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .p-card:hover .btn-kick { opacity: 1; }
        .btn-kick:hover { transform: scale(1.2); background: #c0392b; }

        /* SETUP */
        #setup-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            z-index: 999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        .setup-title { color: #ffd700; font-size: 64px; font-family: 'Bebas Neue', sans-serif; letter-spacing: 8px; margin-bottom: 50px; text-shadow: 0 0 40px rgba(255, 215, 0, 0.8); }

        input {
            padding: 18px 30px; font-size: 22px; text-align: center; margin: 12px;
            border-radius: 12px; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3); color: #ffd700; width: 350px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .setup-btn {
            padding: 18px 60px; font-size: 24px;
            background: linear-gradient(145deg, #2ecc71, #27ae60);
            border: none; cursor: pointer; border-radius: 12px; color: white;
            font-weight: bold; margin-top: 30px; font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 3px; box-shadow: 0 6px 25px rgba(46, 204, 113, 0.5);
        }

        /* CONFETTI */
        .confetti { position: absolute; width: 10px; height: 10px; background: #ffd700; pointer-events: none; animation: confettiFall 2s forwards; }
        @keyframes confettiFall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    </style>
</head>

<body>

    <div class="wood-rail"></div>

    <div id="setup-modal">
        <div class="setup-title">POKER HOST</div>
        <input id="room" placeholder="Room Name" autocomplete="off">
        <input id="pass" placeholder="Password (any characters)" autocomplete="off">
        <button class="setup-btn" onclick="startHost()">START TABLE</button>
    </div>

    <div id="table-view" style="display:none;">
        <div class="admin-bar">
            <div class="room-info">
                ROOM: <span id="disp-room"></span>
            </div>
            <div class="controls">
                <button class="btn-action btn-next" onclick="nextRound()">‚è© NEXT ROUND</button>
                <button class="btn-action btn-split" onclick="toggleSplitMode()">üîÄ SPLIT POT</button>
                <button class="btn-action btn-distribute" id="btn-dist" onclick="distributeSplit()">üí∞ DISTRIBUTE</button>
                <button class="btn-action btn-reset" onclick="resetGame()">‚Üª FULL RESET</button>
            </div>
        </div>

        <div class="notification-area" id="notification-area"></div>

        <div class="pot-area">
            <div class="pot-glow" id="pot-glow"></div>
            <div id="chip-pile"></div>
            <div class="pot-text">
                <div class="pot-label">POT</div>
                <div class="pot-val" id="disp-pot">$0</div>
            </div>
        </div>

        <div class="player-layer" id="player-grid"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyApDemI7Jtd76lOo1oPBmHneMb4mHCMxZs",
            authDomain: "poker-night-app-dffc6.firebaseapp.com",
            databaseURL: "https://poker-night-app-dffc6-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "poker-night-app-dffc6",
            storageBucket: "poker-night-app-dffc6.firebasestorage.app",
            messagingSenderId: "304292154404",
            appId: "1:304292154404:web:c1d94e60add9a8f0d75cb1"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let roomID = "";
        let splitMode = false;
        let selectedPlayers = [];
        let previousBets = {};
        let seats = []; // Array of player names in order
        let dealerIndex = 0;
        let turnIndex = 0;

        // AUDIO
        function playSound(frequencies, duration = 0.2) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            frequencies.forEach((freq, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.value = freq;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                osc.start(audioContext.currentTime + i * 0.05);
                osc.stop(audioContext.currentTime + duration + i * 0.05);
            });
        }

        function createConfetti(x, y, count = 30) {
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = x + 'px';
                confetti.style.top = y + 'px';
                confetti.style.background = ['#ffd700', '#f39c12', '#e74c3c', '#2ecc71', '#3498db'][Math.floor(Math.random() * 5)];
                confetti.style.animationDelay = (i * 0.02) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 2000);
            }
        }

        function showNotification(playerName, betAmount, isAllIn = false) {
            const container = document.getElementById('notification-area');
            const notification = document.createElement('div');
            notification.className = 'notification' + (isAllIn ? ' all-in' : '');
            notification.innerHTML = `
                <div class="notification-name">${playerName}</div>
                <div class="notification-bet">+$${betAmount}${isAllIn ? ' ALL IN!' : ''}</div>
            `;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        window.startHost = function () {
            roomID = document.getElementById('room').value.trim().toUpperCase();
            const pass = document.getElementById('pass').value.trim();
            if (!roomID || !pass) return alert("Enter Info");
            
            update(ref(db, `games/${roomID}`), { 
                password: pass, 
                pot: 0,
                dealerIndex: 0,
                turnIndex: 1
            });
            
            document.getElementById('setup-modal').style.display = 'none';
            document.getElementById('table-view').style.display = 'block';
            document.getElementById('disp-room').innerText = roomID;
            playSound([523, 659, 784], 0.3);
            startListener();
        }

        function startListener() {
            onValue(ref(db, `games/${roomID}`), (snap) => {
                const game = snap.val();
                if (!game) return;

                const potAmount = game.pot || 0;
                document.getElementById('disp-pot').innerText = "$" + potAmount;
                renderPotChips(potAmount);

                const glow = document.getElementById('pot-glow');
                if (potAmount > 200) glow.classList.add('active');
                else glow.classList.remove('active');

                // SYNC SEATS
                const players = game.players || {};
                const dbSeats = game.seats || [];
                dealerIndex = game.dealerIndex || 0;
                turnIndex = game.turnIndex || 0;

                // Add new players to seats if missing
                let seatsUpdated = false;
                Object.keys(players).forEach(pName => {
                    if (!dbSeats.includes(pName)) {
                        dbSeats.push(pName);
                        seatsUpdated = true;
                    }
                });
                
                // Remove players who left
                const cleanedSeats = dbSeats.filter(name => players[name]);
                if (cleanedSeats.length !== dbSeats.length) seatsUpdated = true;

                if (seatsUpdated) {
                    update(ref(db, `games/${roomID}`), { seats: cleanedSeats });
                    return; // Wait for next update
                }

                seats = cleanedSeats; // Update local scope

                // Notifications
                Object.entries(players).forEach(([name, p]) => {
                    const currentBet = p.currentBet || 0;
                    const previousBet = previousBets[name] || 0;
                    if (currentBet > previousBet) {
                        showNotification(name, currentBet - previousBet, (p.chips === 0 && currentBet > 0));
                    }
                    previousBets[name] = currentBet;
                });

                renderGrid(players);
            });
        }

        function renderGrid(players) {
            const grid = document.getElementById('player-grid');
            grid.innerHTML = "";
            
            seats.forEach((pName, index) => {
                const p = players[pName];
                const isFolded = (p.status === 'folded');
                const isTurn = (index === turnIndex);
                const isDealer = (index === dealerIndex);
                const isSelected = selectedPlayers.includes(pName) ? 'selected' : '';

                let winButton = `<button class="btn-win" onclick="givePot('${pName}')">üèÜ WIN</button>`;
                if (isFolded) winButton = `<span style="font-size:11px; color:#555; font-weight:bold;">FOLDED</span>`;
                if (splitMode) winButton = `<span style="font-size:11px; color:#3498db; font-weight:bold;">SELECT</span>`;

                const avatars = ['üÉè', '‚ô†Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', '‚ô£Ô∏è', 'üé∞', 'üé≤', 'üëë'];
                const avatar = avatars[index % avatars.length];

                grid.innerHTML += `
                    <div class="p-card ${isFolded ? 'folded' : ''} ${isSelected} ${isTurn ? 'active-turn' : ''}" onclick="handleCardClick('${pName}', ${isFolded})">
                        ${isDealer ? '<div class="dealer-btn">D</div>' : ''}
                        
                        <button class="seat-arrow arrow-left" onclick="swapSeat(${index}, -1, event)"><</button>
                        
                        <div class="p-avatar">${avatar}</div>
                        <div class="p-name">${pName}</div>
                        <div class="p-chips">$${p.chips}</div>
                        <div class="p-bet">BET: $${p.currentBet || 0}</div>
                        ${winButton}
                        
                        <button class="seat-arrow arrow-right" onclick="swapSeat(${index}, 1, event)">></button>
                        
                        <button class="btn-kick" onclick="kickPlayer('${pName}', event)">‚úñ</button>
                    </div>
                `;
            });
        }

        window.swapSeat = function(currentIndex, direction, event) {
            event.stopPropagation();
            const targetIndex = currentIndex + direction;
            if (targetIndex < 0 || targetIndex >= seats.length) return;

            // Swap
            const temp = seats[currentIndex];
            seats[currentIndex] = seats[targetIndex];
            seats[targetIndex] = temp;

            update(ref(db, `games/${roomID}`), { seats: seats });
        }

        // NEW: KICK FUNCTION
        window.kickPlayer = function(name, event) {
            event.stopPropagation();
            if (!confirm(`Permanently remove ${name} from the game?`)) return;
            
            // 1. Remove from Players object
            remove(ref(db, `games/${roomID}/players/${name}`));
            
            // 2. Remove from Seats array immediately to prevent errors
            const newSeats = seats.filter(p => p !== name);
            update(ref(db, `games/${roomID}`), { seats: newSeats });
            
            playSound([400, 300], 0.2);
        }

        window.nextRound = function() {
            // Rotates Dealer, Resets Bets, Clears Pot
            get(ref(db, `games/${roomID}`)).then(snap => {
                const game = snap.val();
                
                // Calculate next dealer
                const nextDealer = (dealerIndex + 1) % seats.length;
                // Next turn is dealer + 1 (Small Blind position)
                const nextTurn = (nextDealer + 1) % seats.length;

                const updates = {};
                updates[`games/${roomID}/pot`] = 0;
                updates[`games/${roomID}/dealerIndex`] = nextDealer;
                updates[`games/${roomID}/turnIndex`] = nextTurn;

                // Reset player statuses
                Object.keys(game.players || {}).forEach(k => {
                    updates[`games/${roomID}/players/${k}/currentBet`] = 0;
                    updates[`games/${roomID}/players/${k}/status`] = 'active';
                });

                update(ref(db), updates);
                playSound([600, 800], 0.3);
            });
        }

        // SPLIT MODE
        window.toggleSplitMode = function () {
            splitMode = !splitMode;
            selectedPlayers = [];
            const btn = document.querySelector('.btn-split');
            const distBtn = document.getElementById('btn-dist');

            if (splitMode) {
                btn.style.background = 'linear-gradient(145deg, #2ecc71, #27ae60)';
                btn.innerText = "‚úì DONE";
                distBtn.style.display = 'block';
            } else {
                btn.style.background = 'linear-gradient(145deg, #3498db, #2980b9)';
                btn.innerText = "üîÄ SPLIT";
                distBtn.style.display = 'none';
            }
            renderGrid(previousBets); // Force re-render
        }

        window.handleCardClick = function (name, isFolded) {
            if (!splitMode || isFolded) return;
            if (selectedPlayers.includes(name)) selectedPlayers = selectedPlayers.filter(p => p !== name);
            else selectedPlayers.push(name);
            
            // Toggle visual class immediately
            const cards = document.querySelectorAll('.p-card');
            cards.forEach(card => {
                if (card.querySelector('.p-name').innerText === name) card.classList.toggle('selected');
            });
        }

        window.distributeSplit = function () {
            if (selectedPlayers.length < 2) return alert("Select at least 2 players!");
            get(ref(db, `games/${roomID}`)).then(snap => {
                const game = snap.val();
                const totalPot = game.pot || 0;
                const share = Math.floor(totalPot / selectedPlayers.length);
                const updates = {};
                selectedPlayers.forEach(winner => {
                    updates[`games/${roomID}/players/${winner}/chips`] = game.players[winner].chips + share;
                });
                update(ref(db), updates);
                toggleSplitMode();
                nextRound(); // Auto advance round after splitting
            });
        }

        window.givePot = function (name) {
            if (splitMode) return;
            get(ref(db, `games/${roomID}`)).then(snap => {
                const game = snap.val();
                const potAmount = game.pot || 0;
                if (potAmount === 0) return alert("Pot is empty!");
                if (!confirm(`Give $${potAmount} to ${name}?`)) return;

                const updates = {};
                updates[`games/${roomID}/players/${name}/chips`] = game.players[name].chips + potAmount;
                update(ref(db), updates);
                
                playSound([523, 659, 784, 1047], 0.5);
                
                // Confetti at winner's card
                const cards = document.querySelectorAll('.p-card');
                cards.forEach(card => {
                    if (card.querySelector('.p-name').innerText === name) {
                        const rect = card.getBoundingClientRect();
                        createConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2, 40);
                    }
                });

                setTimeout(() => nextRound(), 2000); // Auto advance after 2s glory
            });
        }

        window.resetGame = function () {
            if (!confirm("RESET ENTIRE GAME? All chips ‚Üí $1000")) return;
            get(ref(db, `games/${roomID}`)).then(snap => {
                const game = snap.val();
                const updates = {};
                updates[`games/${roomID}/pot`] = 0;
                updates[`games/${roomID}/dealerIndex`] = 0;
                updates[`games/${roomID}/turnIndex`] = 0;
                
                if (game.players) {
                    Object.keys(game.players).forEach(k => {
                        updates[`games/${roomID}/players/${k}/chips`] = 1000;
                        updates[`games/${roomID}/players/${k}/currentBet`] = 0;
                        updates[`games/${roomID}/players/${k}/status`] = 'active';
                    });
                }
                update(ref(db), updates);
                playSound([200, 150, 100], 0.3);
            });
        }

        function renderPotChips(amount) {
            const pile = document.getElementById('chip-pile');
            pile.innerHTML = "";
            let remaining = amount;
            const chips = [];
            while (remaining >= 100) { chips.push(100); remaining -= 100; }
            while (remaining >= 25) { chips.push(25); remaining -= 25; }
            while (remaining >= 5) { chips.push(5); remaining -= 5; }
            while (remaining >= 1) { chips.push(1); remaining -= 1; }
            
            const max = 50; // Cap visual chips to prevent lag
            const step = Math.ceil(chips.length / max);
            
            for (let i = 0; i < chips.length; i += (step > 1 ? step : 1)) {
                const val = chips[i];
                const d = document.createElement('div');
                let cls = "vc1";
                if (val === 5) cls = "vc5";
                if (val === 25) cls = "vc25";
                if (val === 100) cls = "vc100";
                
                d.className = `chip-visual ${cls}`;
                d.innerText = val;
                
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * 80;
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;
                const rot = Math.random() * 360;
                
                d.style.transform = `translate(${x}px, ${y}px) rotate(${rot}deg)`;
                d.style.zIndex = i;
                pile.appendChild(d);
            }
        }
    </script>
</body>

</html>
